var TAFFY,exports,T;
!function(){var I,H;if(!TAFFY){var K=1;var v={};var F=function(a){return Array.prototype.slice.call(a).sort()};var Q=function(a){return TAFFY.isArray(a)||TAFFY.isObject(a)?a:JSON.parse(a)};var R=function(a){return"[object RegExp]"===Object.prototype.toString.call(a)};var L=function(a){var b=T.isArray(a)?[]:T.isObject(a)?{}:null;if(null===a)return a;for(var d in a)b[d]=R(a[d])?a[d].toString():T.isArray(a[d])||T.isObject(a[d])?L(a[d]):a[d];return b};var S=function(a){var b=JSON.stringify(a);return null===
b.match(/regex/)?b:JSON.stringify(L(a))};var n=function(a,b,d){var e,g,c;if(a&&(T.isArray(a)&&1===a.length||!T.isArray(a)))b(T.isArray(a)?a[0]:a,0);else{var k=0;a=T.isArray(a)?a:[a];for(c=a.length;c>k&&(g=a[k],T.isUndefined(g)&&!d||(e=b(g,k),e!==T.EXIT));k++);}};var D=function(a,b){var d,e,g=0;for(e in a)if(a.hasOwnProperty(e)&&(d=b(a[e],e,g++),d===T.EXIT))break};v.extend=function(a,b){v[a]=function(){return b.apply(this,F(arguments))}};var M=function(a){var b;return T.isString(a)&&/[t][0-9]*[r][0-9]*/i.test(a)?
!0:T.isObject(a)&&a.___id&&a.___s?!0:T.isArray(a)?(b=!0,n(a,function(d){return M(d)?void 0:(b=!1,TAFFY.EXIT)}),b):!1};var A=function(a,b){var d=!0;return n(b,function(e){switch(T.typeOf(e)){case "function":if(!e.apply(a))return d=!1,TAFFY.EXIT;break;case "array":d=1===e.length?A(a,e[0]):2===e.length?A(a,e[0])||A(a,e[1]):3===e.length?A(a,e[0])||A(a,e[1])||A(a,e[2]):4===e.length?A(a,e[0])||A(a,e[1])||A(a,e[2])||A(a,e[3]):!1,4<e.length&&n(e,function(g){A(a,g)&&(d=!0)})}}),d};var J=function(a){var b=
[];return T.isString(a)&&/[t][0-9]*[r][0-9]*/i.test(a)&&(a={___id:a}),T.isArray(a)?(n(a,function(d){b.push(J(d))}),a=function(){var d=this,e=!1;return n(b,function(g){A(d,g)&&(e=!0)}),e}):T.isObject(a)?(T.isObject(a)&&a.___id&&a.___s&&(a={___id:a.___id}),D(a,function(d,e){T.isObject(d)||(d={is:d});D(d,function(g,c){var k=[];("hasAll"===c?function(f,p){p(f)}:n)(g,function(f){var p=!0;k.push(function(){var r,m=this[e];return"undefined"==typeof m?!1:(0===c.indexOf("!")&&"!="!==c&&"!=="!==c&&(p=!1,c=
c.substring(1,c.length)),r="regex"===c?f.test(m):"lt"===c||"<"===c?f>m:"gt"===c||">"===c?m>f:"lte"===c||"<="===c?f>=m:"gte"===c||">="===c?m>=f:"left"===c?0===m.indexOf(f):"leftnocase"===c?0===m.toLowerCase().indexOf(f.toLowerCase()):"right"===c?m.substring(m.length-f.length)===f:"rightnocase"===c?m.toLowerCase().substring(m.length-f.length)===f.toLowerCase():"like"===c?0<=m.indexOf(f):"likenocase"===c?0<=m.toLowerCase().indexOf(f.toLowerCase()):"==="===c||"is"===c?m===f:"=="===c?m==f:"!=="===c?m!==
f:"!="===c?m!=f:"isnocase"===c?m.toLowerCase?m.toLowerCase()===f.toLowerCase():m===f:"has"===c?T.has(m,f):"hasall"===c?T.hasAll(m,f):"contains"===c?TAFFY.isArray(m)&&-1<m.indexOf(f):-1!==c.indexOf("is")||TAFFY.isNull(m)||TAFFY.isUndefined(m)||TAFFY.isObject(f)||TAFFY.isArray(f)?T[c]&&T.isFunction(T[c])&&0===c.indexOf("is")?T[c](m)===f:T[c]&&T.isFunction(T[c])?T[c](m,f):!1:f===m[c],r&&!p?!1:r||p?r:!0)})});b.push(1===k.length?k[0]:function(){var f=this,p=!1;return n(k,function(r){r.apply(f)&&(p=!0)}),
p})})}),a=function(){var d=this,e=!0;return e=(1!==b.length||b[0].apply(d))&&(2!==b.length||b[0].apply(d)&&b[1].apply(d))&&(3!==b.length||b[0].apply(d)&&b[1].apply(d)&&b[2].apply(d))&&(4!==b.length||b[0].apply(d)&&b[1].apply(d)&&b[2].apply(d)&&b[3].apply(d))?!0:!1,4<b.length&&n(b,function(g){A(d,g)||(e=!1)}),e}):T.isFunction(a)?a:void 0};var N=function(a,b){var d=function(e,g){var c=0;return T.each(b,function(k){var f,p;if(f=k.split(" "),k=f[0],p=1===f.length?"logical":f[1],"logical"===p){var r=H(e[k]);
var m=H(g[k]);T.each(r.length<=m.length?r:m,function(y,h){return r[h]<m[h]?(c=-1,TAFFY.EXIT):r[h]>m[h]?(c=1,TAFFY.EXIT):void 0})}else if("logicaldesc"===p)r=H(e[k]),m=H(g[k]),T.each(r.length<=m.length?r:m,function(y,h){return r[h]>m[h]?(c=-1,TAFFY.EXIT):r[h]<m[h]?(c=1,TAFFY.EXIT):void 0});else{if("asec"===p&&e[k]<g[k])return c=-1,T.EXIT;if("asec"===p&&e[k]>g[k])return c=1,T.EXIT;if("desc"===p&&e[k]>g[k])return c=-1,T.EXIT;if("desc"===p&&e[k]<g[k])return c=1,T.EXIT}return 0===c&&"logical"===p&&r.length<
m.length?c=-1:0===c&&"logical"===p&&r.length>m.length?c=1:0===c&&"logicaldesc"===p&&r.length>m.length?c=-1:0===c&&"logicaldesc"===p&&r.length<m.length&&(c=1),0!==c?T.EXIT:void 0}),c};return a&&a.push?a.sort(d):a};(function(){var a={},b=0;H=function(d){1E3<b&&(a={},b=0);var e;if(!(e=a["_"+d])){var g,c=String(d),k=[],f="_",p="";e=0;for(g=c.length;g>e;e++){var r=c.charCodeAt(e);48<=r&&57>=r||46===r?("n"!==p&&(p="n",k.push(f.toLowerCase()),f=""),f+=c.charAt(e)):("s"!==p&&(p="s",k.push(parseFloat(f)),
f=""),f+=c.charAt(e))}e=(k.push("n"===p?parseFloat(f):f.toLowerCase()),k.shift(),a["_"+d]=k,b++,k)}return e}})();var z=function(){this.context({results:this.getDBI().query(this.context())})};v.extend("filter",function(){var a=TAFFY.mergeObj(this.context(),{run:null}),b=[];return n(a.q,function(d){b.push(d)}),a.q=b,n(F(arguments),function(d){a.q.push(J(d));a.filterRaw.push(d)}),this.getroot(a)});v.extend("order",function(a){a=a.split(",");var b,d=[];return n(a,function(e){d.push(e.replace(/^\s*/,"").replace(/\s*$/,
""))}),b=TAFFY.mergeObj(this.context(),{sort:null}),b.order=d,this.getroot(b)});v.extend("limit",function(a){var b,d=TAFFY.mergeObj(this.context(),{});return d.limit=a,d.run&&d.sort&&(b=[],n(d.results,function(e,g){return g+1>a?TAFFY.EXIT:void b.push(e)}),d.results=b),this.getroot(d)});v.extend("start",function(a){var b,d=TAFFY.mergeObj(this.context(),{});return d.start=a,d.run&&d.sort&&!d.limit?(b=[],n(d.results,function(e,g){g+1>a&&b.push(e)}),d.results=b):d=TAFFY.mergeObj(this.context(),{run:null,
start:a}),this.getroot(d)});v.extend("update",function(a,b,d){var e,g=!0,c={},k=F(arguments);return!TAFFY.isString(a)||2!==arguments.length&&3!==arguments.length?(c=a,2===k.length&&(g=b)):(c[a]=b,3===arguments.length&&(g=d)),e=this,z.call(this),n(this.context().results,function(f){var p=c;TAFFY.isFunction(p)?p=p.apply(TAFFY.mergeObj(f,{})):T.isFunction(p)&&(p=p(TAFFY.mergeObj(f,{})));TAFFY.isObject(p)&&e.getDBI().update(f.___id,p,g)}),this.context().results.length&&this.context({run:null}),this});
v.extend("remove",function(a){var b=this,d=0;return z.call(this),n(this.context().results,function(e){b.getDBI().remove(e.___id);d++}),this.context().results.length&&(this.context({run:null}),b.getDBI().removeCommit(a)),d});v.extend("count",function(){return z.call(this),this.context().results.length});v.extend("callback",function(a,b){if(a){var d=this;setTimeout(function(){z.call(d);a.call(d.getroot(d.context()))},b||0)}return null});v.extend("get",function(){return z.call(this),this.context().results});
v.extend("stringify",function(){return JSON.stringify(this.get())});v.extend("first",function(){return z.call(this),this.context().results[0]||!1});v.extend("last",function(){return z.call(this),this.context().results[this.context().results.length-1]||!1});v.extend("sum",function(){var a=0,b=this;return z.call(b),n(F(arguments),function(d){n(b.context().results,function(e){a+=e[d]||0})}),a});v.extend("min",function(a){var b=null;return z.call(this),n(this.context().results,function(d){(null===b||
d[a]<b)&&(b=d[a])}),b});(function(){var a=function(){var b,d;return b=function(e,g,c){var k,f,p;switch(2===c.length?(k=e[c[0]],p="===",f=g[c[1]]):(k=e[c[0]],p=c[1],f=g[c[2]]),p){case "===":return k===f;case "!==":return k!==f;case "<":return f>k;case ">":return k>f;case "<=":return f>=k;case ">=":return k>=f;case "==":return k==f;case "!=":return k!=f;default:throw String(p)+" is not supported";}},d=function(e,g){var c,k,f={};for(c in e)e.hasOwnProperty(c)&&(f[c]=e[c]);for(c in g)g.hasOwnProperty(c)&&
"___id"!==c&&"___s"!==c&&(k=TAFFY.isUndefined(f[c])?"":"right_",f[k+String(c)]=g[c]);return f},function(e){var g,c=F(arguments),k=c.length,f=[];if("function"!=typeof e.filter){if(!e.TAFFY)throw"TAFFY DB or result not supplied";var p=e()}else p=e;return this.context({results:this.getDBI().query(this.context())}),TAFFY.each(this.context().results,function(r){p.each(function(m){var y,h=!0;g=1;for(;k>g&&(y=c[g],h="function"==typeof y?y(r,m):"object"==typeof y&&y.length?b(r,m,y):!1,h);g++);h&&f.push(d(r,
m))})}),TAFFY(f)()}}();v.extend("join",a)})();v.extend("max",function(a){var b=null;return z.call(this),n(this.context().results,function(d){(null===b||d[a]>b)&&(b=d[a])}),b});v.extend("select",function(){var a=[],b=F(arguments);return z.call(this),1===arguments.length?n(this.context().results,function(d){a.push(d[b[0]])}):n(this.context().results,function(d){var e=[];n(b,function(g){e.push(d[g])});a.push(e)}),a});v.extend("distinct",function(){var a=[],b=F(arguments);return z.call(this),1===arguments.length?
n(this.context().results,function(d){var e=d[b[0]],g=!1;n(a,function(c){return e===c?(g=!0,TAFFY.EXIT):void 0});g||a.push(e)}):n(this.context().results,function(d){var e=[],g=!1;n(b,function(c){e.push(d[c])});n(a,function(c){var k=!0;return n(b,function(f,p){return e[p]!==c[p]?(k=!1,TAFFY.EXIT):void 0}),k?(g=!0,TAFFY.EXIT):void 0});g||a.push(e)}),a});v.extend("supplant",function(a,b){var d=[];return z.call(this),n(this.context().results,function(e){d.push(a.replace(/\{([^\{\}]*)\}/g,function(g,c){var k=
e[c];return"string"==typeof k||"number"==typeof k?k:g}))}),b?d:d.join("")});v.extend("each",function(a){return z.call(this),n(this.context().results,a),this});v.extend("map",function(a){var b=[];return z.call(this),n(this.context().results,function(d){b.push(a(d))}),b});TAFFY=T=function(a){var b,d,e,g=[],c={},k=1,f={template:!1,onInsert:!1,onUpdate:!1,onRemove:!1,onDBChange:!1,storageName:!1,forcePropertyCase:null,cacheSize:100,name:""},p=new Date,r=0,m=0,y={};return d=function(h){var l=[],q=!1;return 0===
h.length?g:(n(h,function(u){T.isString(u)&&/[t][0-9]*[r][0-9]*/i.test(u)&&g[c[u]]&&(l.push(g[c[u]]),q=!0);T.isObject(u)&&u.___id&&u.___s&&g[c[u.___id]]&&(l.push(g[c[u.___id]]),q=!0);T.isArray(u)&&n(u,function(B){n(d(B),function(t){l.push(t)})})}),q&&1<l.length&&(l=[]),l)},b={dm:function(h){return h&&(p=h,y={},r=0,m=0),f.onDBChange&&setTimeout(function(){f.onDBChange.call(g)},0),f.storageName&&setTimeout(function(){localStorage.setItem("taffy_"+f.storageName,JSON.stringify(g))}),p},insert:function(h,
l){var q=[],u=[],B=Q(h);return n(B,function(t,C){var w,x;return T.isArray(t)&&0===C?(n(t,function(E){q.push("lower"===f.forcePropertyCase?E.toLowerCase():"upper"===f.forcePropertyCase?E.toUpperCase():E)}),!0):(T.isArray(t)?(w={},n(t,function(E,G){w[q[G]]=E}),t=w):T.isObject(t)&&f.forcePropertyCase&&(x={},D(t,function(E,G){x["lower"===f.forcePropertyCase?G.toLowerCase():"upper"===f.forcePropertyCase?G.toUpperCase():G]=t[G]}),t=x),k++,t.___id="T"+String("000000"+K).slice(-6)+"R"+String("000000"+k).slice(-6),
t.___s=!0,u.push(t.___id),f.template&&(t=T.mergeObj(f.template,t)),g.push(t),c[t.___id]=g.length-1,f.onInsert&&(l||TAFFY.isUndefined(l))&&f.onInsert.call(t),void b.dm(new Date))}),e(u)},sort:function(h){return g=N(g,h.split(",")),c={},n(g,function(l,q){c[l.___id]=q}),b.dm(new Date),!0},update:function(h,l,q){var u={};f.forcePropertyCase&&(D(l,function(w,x){u["lower"===f.forcePropertyCase?x.toLowerCase():"upper"===f.forcePropertyCase?x.toUpperCase():x]=w}),l=u);var B=g[c[h]];l=T.mergeObj(B,l);var t=
{};var C=!1;D(l,function(w,x){(TAFFY.isUndefined(B[x])||B[x]!==w)&&(t[x]=w,C=!0)});C&&(f.onUpdate&&(q||TAFFY.isUndefined(q))&&f.onUpdate.call(l,g[c[h]],t),g[c[h]]=l,b.dm(new Date))},remove:function(h){g[c[h]].___s=!1},removeCommit:function(h){var l;for(l=g.length-1;-1<l;l--)g[l].___s||(f.onRemove&&(h||TAFFY.isUndefined(h))&&f.onRemove.call(g[l]),c[g[l].___id]=void 0,g.splice(l,1));c={};n(g,function(q,u){c[q.___id]=u});b.dm(new Date)},query:function(h){var l,q,u,B,t,C;if(f.cacheSize&&(q="",n(h.filterRaw,
function(w){return T.isFunction(w)?(q="nocache",TAFFY.EXIT):void 0}),""===q&&(q=S(T.mergeObj(h,{q:!1,run:!1,sort:!1})))),!h.results||!h.run||h.run&&b.dm()>h.run){if(u=[],f.cacheSize&&y[q])return y[q].i=r++,y[q].results;0===h.q.length&&0===h.index.length?(n(g,function(w){u.push(w)}),l=u):(B=d(h.index),n(B,function(w){(0===h.q.length||A(w,h.q))&&u.push(w)}),l=u)}else l=h.results;return!(0<h.order.length)||h.run&&h.sort||(l=N(l,h.order)),l.length&&(h.limit&&h.limit<l.length||h.start)&&(t=[],n(l,function(w,
x){if(!h.start||h.start&&x+1>=h.start)if(h.limit)if(C=h.start?x+1-h.start:x,C<h.limit)t.push(w);else{if(C>h.limit)return TAFFY.EXIT}else t.push(w)}),l=t),f.cacheSize&&"nocache"!==q&&(m++,setTimeout(function(){var w,x;m>=2*f.cacheSize&&(m=0,w=r-f.cacheSize,x={},D(function(E,G){E.i>=w&&(x[G]=E)}),y=x)},0),y[q]={i:r++,results:l}),l}},e=function(){var h,l;return h=TAFFY.mergeObj(TAFFY.mergeObj(v,{insert:void 0}),{getDBI:function(){return b},getroot:function(q){return e.call(q)},context:function(q){return q&&
(l=TAFFY.mergeObj(l,q.hasOwnProperty("results")?TAFFY.mergeObj(q,{run:new Date,sort:new Date}):q)),l},extend:void 0}),l=this&&this.q?this:{limit:!1,start:!1,q:[],filterRaw:[],index:[],order:[],results:!1,run:null,sort:null,settings:f},n(F(arguments),function(q){M(q)?l.index.push(q):l.q.push(J(q));l.filterRaw.push(q)}),h},K++,a&&b.insert(a),e.insert=b.insert,e.merge=function(h,l,q){var u={},B=[],t={};return q=q||!1,l=l||"id",n(h,function(C){var w;u[l]=C[l];B.push(C[l]);(w=e(u).first())?b.update(w.___id,
C,q):b.insert(C,q)}),t[l]=B,e(t)},e.TAFFY=!0,e.sort=b.sort,e.settings=function(h){return h&&(f=TAFFY.mergeObj(f,h),h.template&&e().update(h.template)),f},e.store=function(h){var l;return localStorage&&(h&&(l=localStorage.getItem("taffy_"+h),l&&0<l.length&&e.insert(l),0<g.length&&setTimeout(function(){localStorage.setItem("taffy_"+f.storageName,JSON.stringify(g))})),e.settings({storageName:h})),e},e};T.each=n;T.eachin=D;T.extend=v.extend;TAFFY.EXIT="TAFFYEXIT";TAFFY.mergeObj=function(a,b){var d={};
return D(a,function(e,g){d[g]=a[g]}),D(b,function(e,g){d[g]=b[g]}),d};TAFFY.has=function(a,b){var d,e=!1;if(a.TAFFY)return e=a(b),0<e.length?!0:!1;switch(T.typeOf(a)){case "object":if(T.isObject(b))D(b,function(g,c){return!0!==e||T.isUndefined(a[c])||!a.hasOwnProperty(c)?(e=!1,TAFFY.EXIT):void(e=T.has(a[c],b[c]))});else if(T.isArray(b))n(b,function(g,c){return e=T.has(a,b[c]),e?TAFFY.EXIT:void 0});else if(T.isString(b))return TAFFY.isUndefined(a[b])?!1:!0;return e;case "array":if(T.isObject(b))n(a,
function(g,c){return e=T.has(a[c],b),!0===e?TAFFY.EXIT:void 0});else if(T.isArray(b))n(b,function(g,c){return n(a,function(k,f){return e=T.has(a[f],b[c]),!0===e?TAFFY.EXIT:void 0}),!0===e?TAFFY.EXIT:void 0});else if(T.isString(b)||T.isNumber(b))for(e=!1,d=0;d<a.length;d++)if(e=T.has(a[d],b))return!0;return e;case "string":if(T.isString(b)&&b===a)return!0;break;default:if(T.typeOf(a)===T.typeOf(b)&&a===b)return!0}return!1};TAFFY.hasAll=function(a,b){var d,e=TAFFY;return e.isArray(b)?(d=!0,n(b,function(g){return d=
e.has(a,g),!1===d?TAFFY.EXIT:void 0}),d):e.has(a,b)};TAFFY.typeOf=function(a){var b=typeof a;return"object"===b&&(a?"number"!=typeof a.length||a.propertyIsEnumerable("length")||(b="array"):b="null"),b};TAFFY.getObjectKeys=function(a){var b=[];return D(a,function(d,e){b.push(e)}),b.sort(),b};TAFFY.isSameArray=function(a,b){return TAFFY.isArray(a)&&TAFFY.isArray(b)&&a.join(",")===b.join(",")?!0:!1};TAFFY.isSameObject=function(a,b){var d=TAFFY,e=!0;return d.isObject(a)&&d.isObject(b)&&d.isSameArray(d.getObjectKeys(a),
d.getObjectKeys(b))?D(a,function(g,c){return d.isObject(a[c])&&d.isObject(b[c])&&d.isSameObject(a[c],b[c])||d.isArray(a[c])&&d.isArray(b[c])&&d.isSameArray(a[c],b[c])||a[c]===b[c]?void 0:(e=!1,TAFFY.EXIT)}):e=!1,e};var O="String Number Object Array Boolean Null Function Undefined".split(" ");var U=function(a){return function(b){return TAFFY.typeOf(b)===a.toLowerCase()?!0:!1}};for(I=0;I<O.length;I++){var P=O[I];TAFFY["is"+P]=U(P)}}}();"object"==typeof exports&&(exports.taffy=TAFFY);